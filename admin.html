<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Sagarmatha Diagnostics</title>
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Poppins:wght@500;600;700&display=swap"
        rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    <style>
        .admin-section {
            padding: 40px 0;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }

        .dashboard-card {
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .dashboard-card h3 {
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
            color: var(--secondary-color);
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        .form-group input[type="file"] {
            padding: 10px 0;
        }

        /* Notification Toast */
        #notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--accent-color);
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body>

    <!-- Header -->
    <header>
        <div class="container">
            <nav class="navbar">
                <a href="index.html" class="logo">
                    <img src="assets/logo.png" alt="Sagarmatha Diagnostics Logo" class="logo-img">
                    Sagarmatha<span>Admin</span>
                </a>
                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="#" class="active">Dashboard</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container admin-section">
        <h1>Lab Administration</h1>
        <p>Manage bookings and upload patient reports. <span id="last-updated"
                style="font-size: 0.8rem; color: #888; margin-left: 10px;"></span></p>

        <!-- Notification Toast -->
        <div id="notification-toast">
            <i class="fas fa-bell"></i> New booking received!
        </div>

        <div class="dashboard-grid">

            <!-- Upload Report Section -->
            <div class="dashboard-card">
                <h3><i class="fas fa-file-upload"></i> Upload Patient Report</h3>
                <form id="admin-upload-form" enctype="multipart/form-data">
                    <div class="form-group">
                        <label>Patient ID (Unique)</label>
                        <input type="text" name="patientId" required placeholder="Ex: PT-1001" id="upload-pid">
                    </div>
                    <div class="form-group">
                        <label>Patient Name</label>
                        <input type="text" name="patientName" required placeholder="Ex: John Doe">
                    </div>
                    <div class="form-group">
                        <label>Patient Email (Optional)</label>
                        <input type="email" name="patientEmail" placeholder="For automatic emailing">
                    </div>
                    <div class="form-group">
                        <label>Report File (PDF)</label>
                        <input type="file" name="reportFile" accept=".pdf" required>
                    </div>
                    <button type="submit" class="btn btn-block">Upload & Send</button>
                    <p id="upload-status" style="margin-top: 10px; font-weight: bold;"></p>
                </form>
            </div>

            <!-- Recent Bookings Section -->
            <div class="dashboard-card">
                <h3><i class="fas fa-calendar-check"></i> Recent Bookings</h3>
                <div style="overflow-x: auto;">
                    <table id="bookings-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Test</th>
                                <th>Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <button onclick="loadBookings()" class="btn-text" style="float: right;">Refresh</button>
            </div>

        </div>
    </div>

    <!-- Custom JS -->
    <script>
        // Backend API URL (Change this to your live server URL after deployment)
        const BASE_URL = ''; // Leave empty for local development

        // Load Bookings on Page Load
        document.addEventListener('DOMContentLoaded', () => {
            loadBookings();
            // Auto-refresh every 30 seconds
            setInterval(() => loadBookings(true), 30000);
        });

        let lastBookingCount = -1;

        async function loadBookings(isSilent = false) {
            const tbody = document.querySelector('#bookings-table tbody');
            const lastUpdated = document.getElementById('last-updated');

            if (!isSilent) {
                tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';
            }

            try {
                const response = await fetch(`${BASE_URL}/api/bookings`);
                const result = await response.json();

                if (result.data) {
                    // Check for new bookings to show notification
                    if (lastBookingCount !== -1 && result.data.length > lastBookingCount) {
                        showNotification();
                    }
                    lastBookingCount = result.data.length;

                    if (result.data.length > 0) {
                        tbody.innerHTML = result.data.map(booking => `
                            <tr>
                                <td>${booking.name}</td>
                                <td>${booking.phone}</td>
                                <td>${booking.test || 'General Inquiry'}</td>
                                <td>${booking.date}</td>
                                <td>
                                    <button class="btn" style="padding: 5px 10px; font-size: 0.8rem;" 
                                        onclick="fillUploadForm('${booking.phone}', '${booking.name}')">
                                        <i class="fas fa-upload"></i> Upload
                                    </button>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="5">No bookings found.</td></tr>';
                    }

                    const now = new Date();
                    lastUpdated.textContent = `Last updated: ${now.toLocaleTimeString()}`;
                }
            } catch (error) {
                console.error('Error:', error);
                if (!isSilent) {
                    tbody.innerHTML = '<tr><td colspan="5" style="color: red;">Error loading bookings. Is server running?</td></tr>';
                }
            }
        }

        function showNotification() {
            const toast = document.getElementById('notification-toast');
            toast.style.display = 'block';

            // Optional: Play subtle sound
            const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
            audio.play().catch(e => console.log("Audio play blocked"));

            setTimeout(() => {
                toast.style.display = 'none';
            }, 5000);
        }

        function fillUploadForm(phone, name) {
            document.getElementById('upload-pid').value = phone;
            document.querySelector('input[name="patientName"]').value = name;
            // Scroll to form
            document.getElementById('admin-upload-form').scrollIntoView({ behavior: 'smooth' });
            // Highlight
            const formCard = document.querySelector('.dashboard-card');
            formCard.style.border = "2px solid var(--primary-color)";
            setTimeout(() => {
                formCard.style.border = "none";
            }, 2000);
        }

        // Handle Report Upload
        document.getElementById('admin-upload-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const status = document.getElementById('upload-status');
            const btn = this.querySelector('button');

            status.textContent = "Uploading...";
            status.style.color = "blue";
            btn.disabled = true;

            const formData = new FormData(this);

            try {
                const response = await fetch(`${BASE_URL}/api/upload-report`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    status.textContent = "Success! Report uploaded.";
                    status.style.color = "green";
                    this.reset();
                } else {
                    status.textContent = "Error: " + (result.error || "Upload failed");
                    status.style.color = "red";
                }
            } catch (error) {
                console.log(error);
                status.textContent = "Network Error.";
                status.style.color = "red";
            } finally {
                btn.disabled = false;
            }
        });
    </script>
</body>

</html>